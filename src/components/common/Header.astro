---
import Brand from "./Brand.jsx";
import ThemeButton from "../ui/ThemeButton.jsx";
import LanguageDropdown from "../ui/LanguageDropdown.jsx";
import HamburgerButton from "./HamburgerButton.astro";
import MobileMenuNew from "./MobileMenuNew.astro";
import { useTranslations } from "../../utils/i18n";
import { getRoute, TASKS } from "../../lib/routes";
import type { ui } from "../../i18n/ui";

interface Props {
    lang?: keyof typeof ui;
    transparent?: boolean;
}

const { lang = "es", transparent = false } = Astro.props;
const t = useTranslations(lang);

const routeMap: Record<string, string> = {};

// Helper to add route with and without trailing slash
const addRoute = (pathEs: string, pathEn: string) => {
    // Exact paths
    routeMap[pathEs] = pathEn;
    routeMap[pathEn] = pathEs;
    // With trailing slash
    if (!pathEs.endsWith("/")) {
        routeMap[pathEs + "/"] = pathEn;
    }
    if (!pathEn.endsWith("/")) {
        routeMap[pathEn + "/"] = pathEs;
    }
};

// Home routes
addRoute("/", "/en");
addRoute("/es", "/en");

// Section paths for language switching on home page
const sectionMappings = [
    { es: "/es/servicios", en: "/en/services" },
    { es: "/es/nosotros", en: "/en/about" },
    { es: "/es/testimonios", en: "/en/testimonials" },
    { es: "/es/contacto", en: "/en/contact" },
];

sectionMappings.forEach(({ es, en }) => {
    addRoute(es, en);
});

// All TASKS routes (soluciones, agendar, etc.)
TASKS.forEach((task) => {
    const slugEs = task.slug.es;
    const slugEn = task.slug.en;

    if (slugEs && slugEn) {
        const pathEs = `/es/${slugEs}`;
        const pathEn = `/en/${slugEn}`;
        addRoute(pathEs, pathEn);
    }
});

const homeUrl = lang === "es" ? "/" : "/en";
const bookingUrl = getRoute("booking", lang);
const assistanceUrl = getRoute("sol-assistance", lang);
const rrhhUrl = getRoute("sol-rrhh", lang);
const projectsUrl = getRoute("sol-projects", lang);
const ssomaUrl = getRoute("sol-ssoma", lang);
const payrollUrl = getRoute("sol-payroll", lang);
const assetsUrl = getRoute("sol-assets", lang);
const flowsUrl = `${getRoute("solutions", lang)}#flujos`;

const isHome =
    Astro.url.pathname === homeUrl ||
    (homeUrl !== "/" && Astro.url.pathname === homeUrl + "/");
---

<header
    id="main-header"
    class={`fixed w-full top-0 z-50 transition-all duration-300 ${transparent ? "glass-nav-transparent" : "glass-nav-solid"}`}
    data-transparent={transparent}
>
    <div class="max-w-7xl mx-auto px-6">
        <div class="flex items-center justify-between h-20">
            <Brand client:load transparent={transparent} lang={lang} />

            <nav class="hidden lg:flex items-center gap-8 text-sm font-medium">
                <a
                    href={homeUrl}
                    class="nav-link pb-3 text-foreground hover:text-primary transition-colors"
                >
                    Inicio
                </a>
                <a
                    href={lang === "es" ? "/servicios" : "/en/services"}
                    class="nav-link pb-3 text-foreground hover:text-primary transition-colors"
                >
                    {t("nav.services")}
                </a>

                <div class="relative group" id="soluciones-container">
                    <button
                        id="soluciones-btn"
                        class="nav-link pb-3 text-foreground hover:text-primary transition-colors flex items-center gap-1 focus:outline-none cursor-pointer"
                        aria-expanded="false"
                        aria-haspopup="true"
                        aria-controls="soluciones-dropdown"
                    >
                        {t("nav.solutions")}
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="w-4 h-4 group-hover:rotate-180 transition-transform"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            ><path d="m6 9 6 6 6-6"></path></svg
                        >
                    </button>

                    <div
                        id="soluciones-dropdown"
                        class="absolute left-0 mt-0 w-64 pt-4 z-50 opacity-0 invisible translate-y-2 transition-all duration-300 ease-out group-hover:opacity-100 group-hover:visible group-hover:translate-y-0"
                    >
                        <div
                            class="bg-panel border border-border rounded-xl shadow-[0_20px_50px_rgba(0,0,0,0.15)] overflow-hidden"
                            style="border-color: var(--color-border); background-color: var(--color-panel);"
                        >
                            <div class="py-2">
                                <a
                                    href={assistanceUrl}
                                    class="block px-4 py-3 hover:bg-primary/5 hover:text-primary transition-colors text-sm"
                                    >{t("module.assistance.title")}</a
                                >
                                <a
                                    href={rrhhUrl}
                                    class="block px-4 py-3 hover:bg-primary/5 hover:text-primary transition-colors text-sm"
                                    >{t("module.rrhh.title")}</a
                                >
                                <a
                                    href={projectsUrl}
                                    class="block px-4 py-3 hover:bg-primary/5 hover:text-primary transition-colors text-sm"
                                    >{t("module.projects.title")}</a
                                >
                                <a
                                    href={ssomaUrl}
                                    class="block px-4 py-3 hover:bg-primary/5 hover:text-primary transition-colors text-sm"
                                    >{t("module.ssoma.title")}</a
                                >
                                <a
                                    href={payrollUrl}
                                    class="block px-4 py-3 hover:bg-primary/5 hover:text-primary transition-colors text-sm"
                                    >{t("module.payroll.title")}</a
                                >
                                <a
                                    href={assetsUrl}
                                    class="block px-4 py-3 hover:bg-primary/5 hover:text-primary transition-colors text-sm"
                                    >{t("module.assets.title")}</a
                                >
                            </div>
                        </div>
                    </div>
                </div>

                <a
                    href={lang === "es" ? "/es/nosotros" : "/en/about"}
                    class="nav-link pb-3 text-foreground hover:text-primary transition-colors"
                >
                    {t("nav.about")}
                </a>
            </nav>

            <div class="flex items-center gap-4">
                <div class="hidden md:block">
                    <LanguageDropdown
                        client:load
                        currentLocale={lang}
                        transparent={transparent}
                        routeMap={routeMap}
                    />
                </div>
                <div class="hidden md:block">
                    <ThemeButton client:visible />
                </div>
                <a
                    href={bookingUrl}
                    class="hidden lg:block px-5 py-2.5 text-sm font-bold rounded-full transition-colors shadow-md hover:opacity-90 active:scale-95 bg-red-600 text-white"
                >
                    {t("nav.demo")}
                </a>
                <HamburgerButton />
            </div>
        </div>
    </div>

    <script>
        const header = document.getElementById("main-header");
        const isTransparent = header?.dataset.transparent === "true";

        const menuBtn = document.getElementById("soluciones-btn");
        const menuDropdown = document.getElementById("soluciones-dropdown");
        if (menuBtn && menuDropdown) {
            menuBtn.addEventListener("click", () => {
                const isExpanded =
                    menuBtn.getAttribute("aria-expanded") === "true";
                menuBtn.setAttribute("aria-expanded", String(!isExpanded));
            });
        }

        if (isTransparent && header) {
            const handleScroll = () => {
                const scrollY = window.scrollY;
                const isScrolled = scrollY > 50;
                if (isScrolled && !header.classList.contains("scrolled")) {
                    header.classList.remove("glass-nav-transparent");
                    header.classList.add("glass-nav-solid", "scrolled");
                    window.dispatchEvent(
                        new CustomEvent("header-scrolled", {
                            detail: { transparent: false },
                        }),
                    );
                } else if (
                    !isScrolled &&
                    header.classList.contains("scrolled")
                ) {
                    header.classList.remove("glass-nav-solid", "scrolled");
                    header.classList.add("glass-nav-transparent");
                    window.dispatchEvent(
                        new CustomEvent("header-scrolled", {
                            detail: { transparent: true },
                        }),
                    );
                }
            };
            window.addEventListener("scroll", handleScroll, { passive: true });
        }
    </script>

    <style>
        .glass-nav-transparent {
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
        }
        .glass-nav-solid {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            border-bottom: 1px solid var(--color-border);
        }
        :global(.dark) .glass-nav-transparent {
            background-color: rgba(17, 24, 39, 0.8);
            border-bottom: 1px solid rgba(31, 41, 55, 0.5);
        }
        :global(.dark) .glass-nav-solid {
            background-color: rgba(17, 24, 39, 0.95);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid var(--color-border);
        }
        .nav-link {
            position: relative;
        }
        .nav-link::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background-color: var(--color-primary);
            transition: width 0.3s ease;
        }
        .nav-link:hover::after {
            width: 100%;
        }
        :global(html:not(.dark)) #main-header img[alt="Kaizen"] {
            filter: brightness(0);
        }
        :global(.dark) #main-header img[alt="Kaizen"] {
            filter: brightness(0) invert(1);
        }
        #soluciones-btn[aria-expanded="true"] + #soluciones-dropdown {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</header>
