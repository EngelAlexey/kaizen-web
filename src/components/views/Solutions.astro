---
import { useTranslations } from "../../utils/i18n";
import { getSlugById } from "../../lib/routes";
import AssistanceService from "../services/AssistanceService.astro";
import HRService from "../services/HRService.astro";
import ProjectsService from "../services/ProjectsService.astro";
import SSOMAService from "../services/SSOMAService.astro";
import PayrollService from "../services/PayrollService.astro";
import AssetsService from "../services/AssetsService.astro";

import {
    Users,
    CalendarRange,
    HardHat,
    FileText,
    Briefcase,
    ShieldCheck,
} from "lucide-react";

interface Props {
    lang?: "es" | "en";
    initialSection?: string;
}

const { lang = "es", initialSection } = Astro.props;
const t = useTranslations(lang);

const services = [
    {
        id: "asistencias",
        routeId: "sol-assistance",
        Component: AssistanceService,
    },
    { id: "rrhh", routeId: "sol-rrhh", Component: HRService },
    { id: "actividades", routeId: "sol-projects", Component: ProjectsService },
    { id: "ssoma", routeId: "sol-ssoma", Component: SSOMAService },
    { id: "finanzas", routeId: "sol-payroll", Component: PayrollService },
    { id: "activos", routeId: "sol-assets", Component: AssetsService },
] as const;
---

<section
    class="relative pt-32 pb-20 px-6 bg-gradient-to-b from-primary/5 to-transparent"
>
    <div class="max-w-4xl mx-auto text-center">
        <span
            class="inline-block py-1 px-3 rounded-full bg-primary/10 text-primary font-bold tracking-widest uppercase text-xs mb-6 border border-primary/20"
        >
            {t("nav.services")}
        </span>
        <h1 class="text-4xl md:text-6xl font-bold mb-6 text-foreground">
            {t("services.hero.title")}
        </h1>
        <p class="text-xl text-muted max-w-2xl mx-auto">
            {t("services.hero.subtitle")}
        </p>
    </div>
</section>

<div class="flex flex-col" transition:persist="solutions-container">
    {
        services.map(({ id, routeId, Component }, index) => {
            const urlSlug = getSlugById(routeId, lang);

            return (
                <section
                    id={id}
                    class:list={[
                        "py-20 px-6 service-section scroll-mt-24",
                        index % 2 !== 0
                            ? "bg-muted/5 border-t border-border"
                            : "",
                    ]}
                    data-slug={urlSlug}
                >
                    <Component lang={lang} />
                </section>
            );
        })
    }
</div>

<section class="py-20 px-6 bg-muted/5 border-t border-border">
    <div class="max-w-7xl mx-auto">
        <h2 class="text-3xl font-bold mb-12 text-center text-foreground">
            {t("services.hero.subtitle")}
        </h2>

        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div
                class="bg-panel p-6 rounded-2xl border border-border shadow-sm hover:shadow-md transition-shadow group"
            >
                <div
                    class="w-12 h-12 rounded-lg bg-blue/10 text-blue flex items-center justify-center mb-6 group-hover:scale-110 transition-transform"
                >
                    <Users />
                </div>
                <h3 class="text-xl font-bold mb-3">{t("module.rrhh.title")}</h3>
                <p class="text-muted text-sm leading-relaxed mb-6">
                    {t("module.rrhh.desc")}
                </p>
            </div>

            <div
                class="bg-panel p-6 rounded-2xl border border-border shadow-sm hover:shadow-md transition-shadow group"
            >
                <div
                    class="w-12 h-12 rounded-lg bg-purple/10 text-purple flex items-center justify-center mb-6 group-hover:scale-110 transition-transform"
                >
                    <CalendarRange />
                </div>
                <h3 class="text-xl font-bold mb-3">
                    {t("module.projects.title")}
                </h3>
                <p class="text-muted text-sm leading-relaxed mb-6">
                    {t("module.projects.desc")}
                </p>
            </div>

            <div
                class="bg-panel p-6 rounded-2xl border border-border shadow-sm hover:shadow-md transition-shadow group"
            >
                <div
                    class="w-12 h-12 rounded-lg bg-red-500/10 text-red-500 flex items-center justify-center mb-6 group-hover:scale-110 transition-transform"
                >
                    <HardHat />
                </div>
                <h3 class="text-xl font-bold mb-3">
                    {t("module.ssoma.title")}
                </h3>
                <p class="text-muted text-sm leading-relaxed mb-6">
                    {t("module.ssoma.desc")}
                </p>
            </div>

            <div
                class="bg-panel p-6 rounded-2xl border border-border shadow-sm hover:shadow-md transition-shadow group"
            >
                <div
                    class="w-12 h-12 rounded-lg bg-emerald/10 text-emerald flex items-center justify-center mb-6 group-hover:scale-110 transition-transform"
                >
                    <FileText />
                </div>
                <h3 class="text-xl font-bold mb-3">
                    {t("module.payroll.title")}
                </h3>
                <p class="text-muted text-sm leading-relaxed mb-6">
                    {t("module.payroll.desc")}
                </p>
            </div>

            <div
                class="bg-panel p-6 rounded-2xl border border-border shadow-sm hover:shadow-md transition-shadow group"
            >
                <div
                    class="w-12 h-12 rounded-lg bg-yellow-500/10 text-yellow-600 flex items-center justify-center mb-6 group-hover:scale-110 transition-transform"
                >
                    <Briefcase />
                </div>
                <h3 class="text-xl font-bold mb-3">
                    {t("module.assets.title")}
                </h3>
                <p class="text-muted text-sm leading-relaxed mb-6">
                    {t("module.assets.desc")}
                </p>
            </div>

            <div
                id="flujos"
                class="bg-panel p-6 rounded-2xl border border-border shadow-sm hover:shadow-md transition-shadow group scroll-mt-24"
            >
                <div
                    class="w-12 h-12 rounded-lg bg-indigo-500/10 text-indigo-500 flex items-center justify-center mb-6 group-hover:scale-110 transition-transform"
                >
                    <ShieldCheck />
                </div>
                <h3 class="text-xl font-bold mb-3">
                    {t("module.flows.title")}
                </h3>
                <p class="text-muted text-sm leading-relaxed mb-6">
                    {t("module.flows.desc")}
                </p>
            </div>
        </div>
    </div>
</section>

<script define:vars={{ initialSection, lang }}>
    const handleNavigation = () => {
        // Find current slug from URL to determine where to scroll
        const path = window.location.pathname;
        const parts = path.split("/").filter(Boolean);
        // Assuming /es/soluciones/slug
        // The last part is the slug.
        // We match it against data-slug attributes.
        const currentSlug = parts[parts.length - 1];

        // Find valid section
        const section = document.querySelector(
            `.service-section[data-slug="${currentSlug}"]`,
        );

        if (section) {
            // Check if we are already seeing it?
            // Naive scroll is safest.
            section.scrollIntoView({
                behavior: "smooth",
                block: "start",
            });
        } else if (initialSection) {
            // Fallback to prop if URL matching fails (e.g. root solutions page?)
            const target = document.getElementById(initialSection);
            if (target) {
                target.scrollIntoView({ behavior: "auto", block: "start" });
            }
        }
    };

    document.addEventListener("astro:page-load", () => {
        // Delay slightly to allow transition to settle or just run?
        // astro:page-load runs after swap.
        handleNavigation();

        const observerOptions = {
            root: null,
            rootMargin: "-20% 0px -80% 0px",
            threshold: 0,
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach((entry) => {
                if (entry.isIntersecting) {
                    const cleanSlug = entry.target.dataset.slug;
                    if (cleanSlug) {
                        const newPath =
                            (lang === "es" ? "/es/" : "/en/") + cleanSlug;
                        if (location.pathname !== newPath) {
                            history.replaceState(null, "", newPath);
                        }
                    }
                }
            });
        }, observerOptions);

        document.querySelectorAll(".service-section").forEach((section) => {
            observer.observe(section);
        });
    });
</script>
