---
import { useTranslations } from "../../utils/i18n";
import { getSlugById } from "../../lib/routes";
import AssistanceService from "../services/AssistanceService.astro";
import HRService from "../services/HRService.astro";
import ProjectsService from "../services/ProjectsService.astro";
import SSOMAService from "../services/SSOMAService.astro";
import PayrollService from "../services/PayrollService.astro";
import AssetsService from "../services/AssetsService.astro";

import {
    Users,
    CalendarRange,
    HardHat,
    FileText,
    Briefcase,
    ShieldCheck,
} from "lucide-react";

interface Props {
    lang?: "es" | "en";
    initialSection?: string;
}

const { lang = "es", initialSection } = Astro.props;
const t = useTranslations(lang);

const services = [
    {
        id: "asistencias",
        routeId: "sol-assistance",
        Component: AssistanceService,
    },
    { id: "rrhh", routeId: "sol-rrhh", Component: HRService },
    { id: "actividades", routeId: "sol-projects", Component: ProjectsService },
    { id: "ssoma", routeId: "sol-ssoma", Component: SSOMAService },
    { id: "finanzas", routeId: "sol-payroll", Component: PayrollService },
    { id: "activos", routeId: "sol-assets", Component: AssetsService },
] as const;
---

<section
    class="relative pt-32 pb-20 px-6 bg-gradient-to-b from-primary/5 to-transparent"
>
    <div class="max-w-4xl mx-auto text-center">
        <span
            class="inline-block py-1 px-3 rounded-full bg-primary/10 text-primary font-bold tracking-widest uppercase text-xs mb-6 border border-primary/20"
        >
            {t("nav.services")}
        </span>
        <h1 class="text-4xl md:text-6xl font-bold mb-6 text-foreground">
            {t("services.hero.title")}
        </h1>
        <p class="text-xl text-muted max-w-2xl mx-auto">
            {t("services.hero.subtitle")}
        </p>
    </div>
</section>

<div class="flex flex-col">
    {
        services.map(({ id, routeId, Component }, index) => {
            const urlSlug = getSlugById(routeId, lang);
            const isOdd = index % 2 !== 0;
            const sectionClasses = isOdd
                ? "py-20 px-6 service-section scroll-mt-24 bg-muted/5 border-t border-border"
                : "py-20 px-6 service-section scroll-mt-24";

            return (
                <section id={id} class={sectionClasses} data-slug={urlSlug}>
                    <Component lang={lang} />
                </section>
            );
        })
    }
</div>

<section class="py-20 px-6 bg-muted/5 border-t border-border">
    <div class="max-w-7xl mx-auto">
        <h2 class="text-3xl font-bold mb-12 text-center text-foreground">
            {t("services.hero.subtitle")}
        </h2>

        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div
                class="bg-panel p-6 rounded-2xl border border-border shadow-sm hover:shadow-md transition-shadow group"
            >
                <div
                    class="w-12 h-12 rounded-lg bg-blue/10 text-blue flex items-center justify-center mb-6 group-hover:scale-110 transition-transform"
                >
                    <Users />
                </div>
                <h3 class="text-xl font-bold mb-3">{t("module.rrhh.title")}</h3>
                <p class="text-muted text-sm leading-relaxed mb-6">
                    {t("module.rrhh.desc")}
                </p>
            </div>

            <div
                class="bg-panel p-6 rounded-2xl border border-border shadow-sm hover:shadow-md transition-shadow group"
            >
                <div
                    class="w-12 h-12 rounded-lg bg-purple/10 text-purple flex items-center justify-center mb-6 group-hover:scale-110 transition-transform"
                >
                    <CalendarRange />
                </div>
                <h3 class="text-xl font-bold mb-3">
                    {t("module.projects.title")}
                </h3>
                <p class="text-muted text-sm leading-relaxed mb-6">
                    {t("module.projects.desc")}
                </p>
            </div>

            <div
                class="bg-panel p-6 rounded-2xl border border-border shadow-sm hover:shadow-md transition-shadow group"
            >
                <div
                    class="w-12 h-12 rounded-lg bg-red-500/10 text-red-500 flex items-center justify-center mb-6 group-hover:scale-110 transition-transform"
                >
                    <HardHat />
                </div>
                <h3 class="text-xl font-bold mb-3">
                    {t("module.ssoma.title")}
                </h3>
                <p class="text-muted text-sm leading-relaxed mb-6">
                    {t("module.ssoma.desc")}
                </p>
            </div>

            <div
                class="bg-panel p-6 rounded-2xl border border-border shadow-sm hover:shadow-md transition-shadow group"
            >
                <div
                    class="w-12 h-12 rounded-lg bg-emerald/10 text-emerald flex items-center justify-center mb-6 group-hover:scale-110 transition-transform"
                >
                    <FileText />
                </div>
                <h3 class="text-xl font-bold mb-3">
                    {t("module.payroll.title")}
                </h3>
                <p class="text-muted text-sm leading-relaxed mb-6">
                    {t("module.payroll.desc")}
                </p>
            </div>

            <div
                class="bg-panel p-6 rounded-2xl border border-border shadow-sm hover:shadow-md transition-shadow group"
            >
                <div
                    class="w-12 h-12 rounded-lg bg-yellow-500/10 text-yellow-600 flex items-center justify-center mb-6 group-hover:scale-110 transition-transform"
                >
                    <Briefcase />
                </div>
                <h3 class="text-xl font-bold mb-3">
                    {t("module.assets.title")}
                </h3>
                <p class="text-muted text-sm leading-relaxed mb-6">
                    {t("module.assets.desc")}
                </p>
            </div>
        </div>
    </div>
</section>

<script define:vars={{ initialSection, lang }}>
    const handleNavigation = () => {
        // 1. Cleanup previous observer
        if (window.solutionsObserver) {
            window.solutionsObserver.disconnect();
            window.solutionsObserver = undefined;
        }

        const path = window.location.pathname;
        const parts = path.split("/").filter(Boolean);
        const currentSlug = parts[parts.length - 1];

        // Use ends-with selector ($=) because data-slug might contain prefixes like 'soluciones/'
        const section = document.querySelector(
            `.service-section[data-slug$="${currentSlug}"]`,
        );

        // Function to start the permanent Scroll Spy
        const startSpyingAll = () => {
            if (window.solutionsObserver) window.solutionsObserver.disconnect();

            const observerOptions = {
                root: null,
                rootMargin: "-20% 0px -80% 0px",
                threshold: 0,
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        const slug = entry.target.dataset.slug;
                        if (slug) {
                            const newPath =
                                (lang === "es" ? "/es/" : "/en/") + slug;
                            if (location.pathname !== newPath) {
                                history.replaceState(null, "", newPath);
                            }
                        }
                    }
                });
            }, observerOptions);

            document.querySelectorAll(".service-section").forEach((sec) => {
                observer.observe(sec);
            });
            window.solutionsObserver = observer;
        };

        if (section) {
            // TUNNEL VISION MODE:
            // Only observe the DESTINATION. Be blind to everything else.

            const destinationObserver = new IntersectionObserver(
                (entries) => {
                    const entry = entries[0];
                    if (entry.isIntersecting) {
                        // We arrived!
                        // 1. Confirm URL (stability)
                        const cleanSlug = entry.target.dataset.slug;
                        const newPath =
                            (lang === "es" ? "/es/" : "/en/") + cleanSlug;

                        if (location.pathname !== newPath) {
                            history.replaceState(null, "", newPath);
                        }

                        // 2. Mission Complete. Stop Tunnel Vision.
                        destinationObserver.disconnect();

                        // 3. Resume normal spying behavior
                        startSpyingAll();
                    }
                },
                {
                    root: null,
                    threshold: 0.1,
                },
            );

            destinationObserver.observe(section);
            window.solutionsObserver = destinationObserver; // Track it so we can kill it if needed

            // Perform the scroll
            // 'auto' allows CSS to control smoothness (defined in global.css)
            section.scrollIntoView({
                behavior: "auto",
                block: "start",
            });
        } else {
            // No specific internal target, just default behavior
            if (initialSection) {
                const target = document.getElementById(initialSection);
                if (target) {
                    target.scrollIntoView({ behavior: "auto", block: "start" });
                }
            }
            startSpyingAll();
        }
    };

    // User Interrupt Logic: If user touches scroll, clear intent
    const FORCE_SPY_ALL = () => {
        // Placeholder for future interrupt handling if needed
    };

    if (!window.hasIntentListeners) {
        window.hasIntentListeners = true;
    }

    // Intercept clicks on Solution links to behave like a Single Page App (SPA)
    // This prevents the "Flash to Top" behavior by avoiding a full page swap.
    const handleInternalLinks = () => {
        document.body.addEventListener("click", (e) => {
            const link = e.target.closest("a");
            if (!link) return;

            const href = link.getAttribute("href");
            if (!href) return;

            // Check if it's an internal link
            if (link.hostname !== window.location.hostname) return;

            // Extract the potential slug from the URL
            // Expected format: /es/soluciones/SLUG or /en/solutions/SLUG
            // We can just check if the path ends with one of our section slugs.
            const url = new URL(link.href);
            const pathParts = url.pathname.split("/").filter(Boolean); // ['es', 'soluciones', 'control-asistencias']
            const candidateSlug = pathParts[pathParts.length - 1];

            if (!candidateSlug) return;

            // Try to find a section that matches this slug
            const targetSection = document.querySelector(
                `.service-section[data-slug$="${candidateSlug}"]`,
            );

            if (targetSection) {
                // FOUND! It's on this page. Hijack the navigation.
                e.preventDefault();

                // 1. Update URL immediately (SPA feel)
                history.pushState(null, "", link.href);

                // 2. Scroll to target
                targetSection.scrollIntoView({
                    behavior: "auto", // CSS 'smooth' handles the physics
                    block: "start",
                });

                // 3. Briefly detach observer to prevent it from overwriting our correct URL during scroll?
                // Actually, our robust observer logic just confirms the URL.
                // Since we just set it to the correct values, the observer will simple agree.
            }
        });
    };

    document.addEventListener("astro:page-load", () => {
        if ("scrollRestoration" in history) {
            history.scrollRestoration = "manual";
        }

        // Execute immediately (Native-like feel)
        handleNavigation();
        handleInternalLinks();
    });

    document.addEventListener("astro:before-swap", () => {
        if (window.solutionsObserver) {
            window.solutionsObserver.disconnect();
            window.solutionsObserver = undefined;
        }
    });
</script>
