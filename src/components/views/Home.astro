---
import { useTranslations } from "../../utils/i18n";
import type { ui } from "../../i18n/ui";
import HeroHome from "../home/HeroHome.astro";
import KaizenHome from "../home/KaizenHome.astro";
import ServicesHome from "../home/ServicesHome.astro";
import ClientsHome from "../home/ClientsHome.astro";

interface Props {
    lang: keyof typeof ui;
    initialSection?: string;
}

const { lang, initialSection } = Astro.props;
const t = useTranslations(lang);
---

<HeroHome lang={lang} />
<KaizenHome lang={lang} />
<ServicesHome lang={lang} />
<ClientsHome lang={lang} />

<script define:vars={{ initialSection, lang }}>
    document.addEventListener("astro:page-load", () => {
        // Only run this logic if we are actually on the Home page
        if (!document.getElementById("inicio")) return;

        // 1. Initial Scroll to Section (Deep Linking)
        if (initialSection) {
            const target = document.getElementById(initialSection);
            if (target) {
                // Small delay to ensure layout is stable
                setTimeout(() => {
                    target.scrollIntoView({
                        behavior: "smooth",
                        block: "start",
                    });
                }, 100);
            }
        }

        // 2. Scroll Spy for URL Updates (Clean URLs)
        const sections = document.querySelectorAll("section[id]");

        const observerOptions = {
            root: null,
            rootMargin: "-20% 0px -80% 0px", // Trigger when section is near top
            threshold: 0,
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach((entry) => {
                if (entry.isIntersecting) {
                    const id = entry.target.getAttribute("id");
                    const currentPathname = window.location.pathname;

                    if (!id) return;

                    let newPath = "";
                    const prefix = lang === "es" ? "/es" : "/en";

                    if (id === "inicio") {
                        // Home root
                        newPath = lang === "es" ? "/" : "/en";
                        // Ideally we keep /es/ for consistency if that's the scheme, but typically root ES is /
                        // Let's check existing behavior. Usually / is ES.
                        // If current path starts with /es, let's keep it explicit?
                        // User requested "http://localhost:4321/es/" for HeroHome.
                        newPath = prefix + "/";
                    } else {
                        // Clean URL: /es/servicios
                        newPath = `${prefix}/${id}`;
                    }

                    if (currentPathname !== newPath) {
                        // Prevent replacing if we are already there (or close enough equivalents like / vs /es/)
                        // But strictly user wants /es/

                        // We use replaceState to avoid cluttering history stack with scroll events
                        history.replaceState(null, "", newPath);
                    }
                }
            });
        }, observerOptions);

        sections.forEach((section) => {
            observer.observe(section);
        });

        // 3. SPA Navigation Interceptor
        const handleInternalLinks = () => {
            document.body.addEventListener("click", (e) => {
                const link = e.target.closest("a");
                if (!link) return;

                const href = link.getAttribute("href");
                if (
                    !href ||
                    href.startsWith("#") ||
                    href.startsWith("mailto:") ||
                    href.startsWith("tel:")
                )
                    return;

                // Check if it's an internal link
                if (link.hostname !== window.location.hostname) return;

                // Extract possible ID from the URL path
                // Expected format: /es/servicios -> id="servicios"
                // Or root: /es/ -> id="inicio"

                const url = new URL(link.href);
                const pathParts = url.pathname.split("/").filter(Boolean);
                // pathParts: ['es', 'servicios'] OR ['es']

                let targetId = "";

                if (pathParts.length <= 1) {
                    // Root /es/ or /en/ -> inicio
                    targetId = "inicio";
                } else {
                    // /es/servicios -> servicios
                    targetId = pathParts[pathParts.length - 1];
                }

                const targetSection = document.getElementById(targetId);

                if (targetSection) {
                    // FOUND! It's on this page. Hijack the navigation.
                    e.preventDefault();

                    // 1. Update URL immediately (SPA feel)
                    history.pushState(null, "", link.href);

                    // 2. Scroll to target
                    targetSection.scrollIntoView({
                        behavior: "smooth",
                        block: "start",
                    });
                }
            });
        };

        handleInternalLinks();
    });
</script>
