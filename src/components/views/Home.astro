---
import { useTranslations } from "../../utils/i18n";
import type { ui } from "../../i18n/ui";
import HeroHome from "../home/HeroHome.astro";
import FeaturesHome from "../home/FeaturesHome.astro";
import ServicesHome from "../home/ServicesHome.astro";
import KaizenHome from "../home/KaizenHome.astro";
import ClientsHome from "../home/ClientsHome.astro";

interface Props {
    lang: keyof typeof ui;
}

const { lang } = Astro.props;
const t = useTranslations(lang);
---

<HeroHome lang={lang} />
<KaizenHome lang={lang} />
<ServicesHome lang={lang} />
<FeaturesHome lang={lang} />
<ClientsHome lang={lang} />

<script>
    document.addEventListener("astro:page-load", () => {
        const sections = document.querySelectorAll("section[id]");

        const observerOptions = {
            root: null,
            rootMargin: "-20% 0px -80% 0px",
            threshold: 0,
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach((entry) => {
                if (entry.isIntersecting) {
                    const id = entry.target.getAttribute("id");
                    const currentPathname = window.location.pathname;
                    const currentHash = window.location.hash;

                    if (id === "inicio") {
                        // For 'inicio', navigate to the base path (e.g., /es/)
                        // Ensure no hash or extra segments are present
                        const basePath =
                            currentPathname.split("/")[0] === ""
                                ? `/${currentPathname.split("/")[1]}/`
                                : currentPathname;
                        if (
                            currentPathname !== basePath ||
                            currentHash !== ""
                        ) {
                            history.replaceState(null, "", basePath);
                        }
                    } else if (id) {
                        // For other IDs, construct a clean path (e.g., /es/servicios)
                        // Get the base path (e.g., /es/)
                        const langSegment = currentPathname.split("/")[1];
                        const newPath = `/${langSegment}/${id}`;

                        // Only update if the path is different to avoid unnecessary history entries
                        if (currentPathname !== newPath) {
                            history.replaceState(null, "", newPath);
                        }
                    }
                }
            });
        }, observerOptions);

        sections.forEach((section) => {
            observer.observe(section);
        });
    });
</script>
