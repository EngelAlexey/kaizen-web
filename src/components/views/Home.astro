---
import { useTranslations } from "../../utils/i18n";
import type { ui } from "../../i18n/ui";
import HeroHome from "../home/HeroHome.astro";
import KaizenHome from "../home/KaizenHome.astro";
import ServicesHome from "../home/ServicesHome.astro";
import ClientsHome from "../home/ClientsHome.astro";
import TestimonialsHome from "../home/TestimonialsHome.astro";

interface Props {
    lang: keyof typeof ui;
    initialSection?: string;
}

const { lang, initialSection } = Astro.props;
const t = useTranslations(lang);
---

<HeroHome lang={lang} />
<KaizenHome lang={lang} />
<ServicesHome lang={lang} />
<ClientsHome lang={lang} />
<TestimonialsHome lang={lang} />

<script define:vars={{ initialSection, lang }}>
    document.addEventListener("astro:page-load", () => {
        if (
            !document.getElementById("inicio") &&
            !document.getElementById("home")
        )
            return;

        if (initialSection) {
            const target = document.getElementById(initialSection);
            if (target) {
                setTimeout(() => {
                    target.scrollIntoView({
                        behavior: "smooth",
                        block: "start",
                    });
                }, 100);
            }
        }

        const sections = document.querySelectorAll("section[id]");

        const observerOptions = {
            root: null,
            rootMargin: "-20% 0px -80% 0px",
            threshold: 0,
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach((entry) => {
                if (entry.isIntersecting) {
                    const id = entry.target.getAttribute("id");
                    const currentPathname = window.location.pathname;

                    if (!id) return;

                    let newPath = "";
                    const prefix = lang === "es" ? "/es" : "/en";

                    if (id === "inicio" || id === "home") {
                        newPath = lang === "es" ? "/es/" : "/en/";
                    } else {
                        newPath = `${prefix}/${id}`;
                    }

                    if (currentPathname !== newPath) {
                        history.replaceState(null, "", newPath);
                    }
                }
            });
        }, observerOptions);

        sections.forEach((section) => {
            observer.observe(section);
        });

        const handleInternalLinks = () => {
            document.body.addEventListener("click", (e) => {
                const link = e.target.closest("a");
                if (!link) return;

                const href = link.getAttribute("href");
                if (
                    !href ||
                    href.startsWith("#") ||
                    href.startsWith("mailto:") ||
                    href.startsWith("tel:")
                )
                    return;

                if (link.hostname !== window.location.hostname) return;

                const url = new URL(link.href);
                const pathParts = url.pathname.split("/").filter(Boolean);
                let targetId = "";

                if (pathParts.length <= 1) {
                    targetId = lang === "es" ? "inicio" : "home";
                } else {
                    targetId = pathParts[pathParts.length - 1];
                }

                const targetSection = document.getElementById(targetId);

                if (targetSection) {
                    e.preventDefault();
                    history.pushState(null, "", link.href);

                    targetSection.scrollIntoView({
                        behavior: "smooth",
                        block: "start",
                    });
                }
            });
        };

        handleInternalLinks();
    });
</script>
